<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Assistive ImageText</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
  <div class="container">
    <h1>Assistive Technology</h1>

    <!-- Default Image -->
    <img src="{{ url_for('static', filename='images/WhatsApp Image 2025-05-30 at 16.24.25_e44f2172.jpg') }}"
      alt="Braille Script Image" class="preview-img" />

    <!-- Upload Form -->
    <form id="image-form" action="{{ url_for('index') }}" method="post" enctype="multipart/form-data" class="upload-form">
      <label for="image">Upload an Image:</label>
      <input type="file" name="image" id="image" accept="image/*" required />
      <button type="submit">Process Image</button>
    </form>

    <!-- Upload Progress -->
    <div id="upload-status">
      <div id="progress-bar-container">
        <div id="progress-bar"></div>
      </div>
      <p id="speed-text"></p>
    </div>

    <!-- Loading Spinner -->
    <div id="loading-spinner" style="display: none; text-align: center; padding: 1rem;">
      <p><strong>Processing...</strong></p>
      <img src="{{ url_for('static', filename='images/spinner.gif') }}" alt="Loading..." style="width: 50px;">
    </div>

    {% if original_image %}
    <div class="result-section">
      <hr>
      <h2>Result</h2>

      <h3>Uploaded Image:</h3>
      <img src="{{ url_for('static', filename=original_image) }}" class="preview-img" />

      <h3>Extracted Text:</h3>
      <div class="output-box">{{ extracted_text }}</div>

      <h3>Braille Text:</h3>
      <div class="braille-container braille">
        <pre>{{ braille_text }}</pre>
      </div>

      <h3>Audio:</h3>
      <audio controls>
        <source src="{{ url_for('static', filename=audio_file) }}" type="audio/mpeg">
        Your browser does not support the audio element.
      </audio>
    </div>
    {% endif %}
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const form = document.getElementById('image-form');
      const progressBar = document.getElementById('progress-bar');
      const uploadStatus = document.getElementById('upload-status');
      const speedText = document.getElementById('speed-text');
      const spinner = document.getElementById('loading-spinner');

      form.addEventListener('submit', function (e) {
        e.preventDefault();

        uploadStatus.style.display = 'block';
        progressBar.style.width = '0%';
        speedText.textContent = '';
        spinner.style.display = 'none';

        const formData = new FormData(form);
        const xhr = new XMLHttpRequest();
        const startTime = new Date().getTime();

        xhr.upload.onprogress = function (event) {
          if (event.lengthComputable) {
            const percent = (event.loaded / event.total) * 100;
            progressBar.style.width = percent.toFixed(2) + '%';
            const elapsedTime = (new Date().getTime() - startTime) / 1000;
            const speed = (event.loaded / 1024 / elapsedTime).toFixed(2);
            speedText.textContent = `Upload Speed: ${speed} KB/s`;
          }
        };

        xhr.onload = function () {
          uploadStatus.style.display = 'none';
          spinner.style.display = 'block';

          if (xhr.status === 200) {
            document.open();
            document.write(xhr.responseText);
            document.close();
          } else {
            spinner.style.display = 'none';
            alert('Upload failed. Please try again.');
          }
        };

        xhr.onerror = function () {
          uploadStatus.style.display = 'none';
          spinner.style.display = 'none';
          alert('Network error. Please check your connection.');
        };

        xhr.open('POST', form.action, true);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        xhr.send(formData);
      });
    });
  </script>
</body>

</html>
